name: gate-grid

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      max_days:
        description: "max holding days (e.g. 40)"
        required: true
        default: "40"
      stop_level:
        description: "stop level (e.g. -0.10)"
        required: true
        default: "-0.10"
      max_extend_days:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"

      p_tail_thresholds:
        description: "comma-separated p_tail thresholds (e.g. 0.10,0.20,0.30)"
        required: true
        default: "0.10,0.20,0.30"
      utility_quantiles:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.60,0.75,0.90"
      ps_mins:
        description: "comma-separated p_success minimum cutoffs (e.g. 0.50,0.60,0.70)"
        required: true
        default: "0.00,0.50,0.60,0.70"
      sub_ps_min:
        description: "SUB entry filter: minimum p_success (e.g. 0.60)"
        required: true
        default: "0.60"
      sub_z_max:
        description: "SUB entry filter: maximum Z_score (e.g. 0.0)"
        required: true
        default: "0.0"
      sub_dd60_max:
        description: "SUB entry filter: maximum Drawdown_60 (e.g. -0.05)"
        required: true
        default: "-0.05"
      rank_metrics:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility,ret_score"
      lambda_tail:
        description: "utility tail penalty lambda (single float, e.g. 0.05)"
        required: true
        default: "0.05"

      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

  schedule:
    # 매일 한국시간 08:10 (UTC 23:10)
    - cron: "10 23 * * *"

jobs:
  grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pyarrow scikit-learn joblib
          fi

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/raw data/features data/labels data/signals data/meta app scripts data/_backup

      - name: Set env keys
        shell: bash
        run: |
          set -euo pipefail
          # NOTE: cache key에는 comma가 들어가면 안되므로 label_spec은 쉼표 대신 _ 로 구성
          echo "LABEL_KEY=pt$(python - <<'PY'
          pt=float("${{ inputs.profit_target }}")
          print(int(round(pt*100)))
          PY
          )_h${{ inputs.max_days }}_sl$(python - <<'PY'
          sl=float("${{ inputs.stop_level }}")
          print(int(round(abs(sl)*100)))
          PY
          )_ex${{ inputs.max_extend_days }}" >> $GITHUB_ENV

          # 10년만 돌릴 거니까 가격 시작일 고정(오늘 기준 대략 10y + 워밍업)
          echo "PRICE_START=2015-02-21" >> $GITHUB_ENV

      # ---- PRICES cache
      - name: Restore cache (PRICES)
        uses: actions/cache@v4
        with:
          path: |
            data/raw/prices.parquet
            data/raw/prices.csv
            data/raw/prices_meta.json
          key: mumumeme-prices-v3-${{ runner.os }}-${{ hashFiles('data/universe.csv','scripts/universe.py','scripts/fetch_prices.py') }}
          restore-keys: |
            mumumeme-prices-v3-${{ runner.os }}-

      # ---- FEATURES cache
      - name: Restore cache (FEATURES_MODEL)
        uses: actions/cache@v4
        with:
          path: |
            data/features/features_model.parquet
            data/features/features_model.csv
          key: mumumeme-features-v3-${{ runner.os }}-${{ hashFiles('data/universe.csv','scripts/universe.py','scripts/fetch_prices.py','scripts/build_features.py') }}
          restore-keys: |
            mumumeme-features-v3-${{ runner.os }}-

      # ---- MODEL cache (labels+model)
      - name: Restore cache (MODEL)
        uses: actions/cache@v4
        with:
          path: |
            data/labels/labels_model.parquet
            data/labels/labels_model.csv
            app/model.pkl
            app/scaler.pkl
          key: mumumeme-model-v3-${{ runner.os }}-${{ env.LABEL_KEY }}-${{ hashFiles('scripts/build_labels.py','scripts/train_model.py') }}
          restore-keys: |
            mumumeme-model-v3-${{ runner.os }}-${{ env.LABEL_KEY }}-
            mumumeme-model-v3-${{ runner.os }}-

      # ✅ TAIL cache (labels_tail + tail model)
      - name: Restore cache (TAIL)
        uses: actions/cache@v4
        with:
          path: |
            data/labels/strategy_raw_data_${{ env.LABEL_KEY }}.parquet
            data/labels/strategy_raw_data_${{ env.LABEL_KEY }}.csv
            data/labels/labels_tail_${{ env.LABEL_KEY }}.parquet
            data/labels/labels_tail_${{ env.LABEL_KEY }}.csv
            app/tail_model.pkl
            app/tail_scaler.pkl
            data/meta/train_tail_report_${{ env.LABEL_KEY }}.json
          key: mumumeme-tail-v3-${{ runner.os }}-${{ env.LABEL_KEY }}-${{ hashFiles('scripts/build_strategy_labels.py','scripts/build_tail_labels.py','scripts/train_tail_model.py') }}
          restore-keys: |
            mumumeme-tail-v3-${{ runner.os }}-${{ env.LABEL_KEY }}-
            mumumeme-tail-v3-${{ runner.os }}-

      - name: Prepare required files (10y only + partial rebuild)
        shell: bash
        env:
          REBUILD_ALL: ${{ inputs.rebuild_all }}
          PRICE_START: ${{ env.PRICE_START }}

          PROFIT_TARGET: ${{ inputs.profit_target }}
          MAX_DAYS: ${{ inputs.max_days }}
          STOP_LEVEL: ${{ inputs.stop_level }}
          MAX_EXTEND_DAYS: ${{ inputs.max_extend_days }}

          LABEL_KEY: ${{ env.LABEL_KEY }}

        run: |
          set -euo pipefail

          if [ "$REBUILD_ALL" = "true" ]; then
            rm -rf data/raw/* data/features/* data/labels/* app/* data/signals/* data/meta/* || true
          fi

          # 1) universe + prices (10y만)
          python scripts/universe.py
          if [ ! -f data/raw/prices.parquet ] && [ ! -f data/raw/prices.csv ]; then
            python scripts/fetch_prices.py --include-extra --reset --force-full --start "$PRICE_START"
          else
            python scripts/fetch_prices.py --include-extra --lookback-days 10 --start "$PRICE_START"
          fi

          # 2) features
          if [ ! -f data/features/features_model.parquet ] && [ ! -f data/features/features_model.csv ]; then
            # 섹터 강도 포함(너가 원한 방향)
            python scripts/build_features.py --enable-sector-strength
          else
            echo "[INFO] features_model exists -> reuse"
          fi

          # 3) labels (p_success 학습 데이터)
          if [ ! -f data/labels/labels_model.parquet ] && [ ! -f data/labels/labels_model.csv ]; then
            python scripts/build_labels.py \
              --profit-target "$PROFIT_TARGET" \
              --max-days "$MAX_DAYS" \
              --stop-level "$STOP_LEVEL"
          else
            echo "[INFO] labels_model exists -> reuse"
          fi

          # 4) model.pkl / scaler.pkl
          if [ ! -f app/model.pkl ] || [ ! -f app/scaler.pkl ]; then
            python scripts/train_model.py
          else
            echo "[INFO] model exists -> reuse"
          fi

          # ✅ 4a) strategy_raw_data_{tag} (Tail 포함)  ← 이게 없으면 tail 라벨을 만들 수가 없음
          if [ ! -f "data/labels/strategy_raw_data_${LABEL_KEY}.parquet" ] && [ ! -f "data/labels/strategy_raw_data_${LABEL_KEY}.csv" ]; then
            python scripts/build_strategy_labels.py \
              --profit-target "$PROFIT_TARGET" \
              --max-days "$MAX_DAYS" \
              --stop-level "$STOP_LEVEL" \
              --max-extend-days "$MAX_EXTEND_DAYS"
          else
            echo "[INFO] strategy_raw_data exists -> reuse"
          fi

          # ✅ 4b) labels_tail_{tag} (TailTarget)  ← train_tail_model.py가 이걸 직접 찾음
          if [ ! -f "data/labels/labels_tail_${LABEL_KEY}.parquet" ] && [ ! -f "data/labels/labels_tail_${LABEL_KEY}.csv" ]; then
            python scripts/build_tail_labels.py \
              --profit-target "$PROFIT_TARGET" \
              --max-days "$MAX_DAYS" \
              --stop-level "$STOP_LEVEL" \
              --max-extend-days "$MAX_EXTEND_DAYS"
          else
            echo "[INFO] labels_tail exists -> reuse"
          fi

          # 4c) tail_model.pkl / tail_scaler.pkl (p_tail)
          if [ ! -f app/tail_model.pkl ] || [ ! -f app/tail_scaler.pkl ]; then
            python scripts/train_tail_model.py \
              --profit-target "$PROFIT_TARGET" \
              --max-days "$MAX_DAYS" \
              --stop-level "$STOP_LEVEL" \
              --max-extend-days "$MAX_EXTEND_DAYS"
          else
            echo "[INFO] tail model exists -> reuse"
          fi
          
          # 5) score features -> features_scored (p_success/p_tail attached)
          python scripts/score_features.py --tag "$LABEL_KEY"

      - name: Run gate grid (predict + simulate + summarize)
        shell: bash
        env:
          LABEL_KEY: ${{ env.LABEL_KEY }}
          PRICE_START: ${{ env.PRICE_START }}

          PROFIT_TARGET: ${{ inputs.profit_target }}
          MAX_DAYS: ${{ inputs.max_days }}
          STOP_LEVEL: ${{ inputs.stop_level }}
          MAX_EXTEND_DAYS: ${{ inputs.max_extend_days }}

          P_TAIL_THRESHOLDS: ${{ inputs.p_tail_thresholds }}
          UTILITY_QUANTILES: ${{ inputs.utility_quantiles }}
          RANK_METRICS: ${{ inputs.rank_metrics }}
          LAMBDA_TAIL: ${{ inputs.lambda_tail }}

          # Gate modes (너가 정한 후보 4개)
          GATE_MODES: "none,tail,utility,tail_utility"

          # ✅ 수익률 우선: TP1 + trailing
          ENABLE_TRAILING: "true"
          TP1_FRAC: "0.50"
          TRAIL_STOPS: "0.08,0.10,0.12"

          # ✅ Top-1 vs Top-2 비교
          TOPK_CONFIGS: "1|1.0;2|0.7,0.3;2|0.6,0.4"

          # ✅ p_success 최소컷도 같이 그리드(너가 원했던 것)
          PS_MINS: ${{ inputs.ps_mins }}

          # ✅ SUB 추격방지 필터 (predict_gate.py -> picks에 SubOK 생성)
          SUB_PS_MIN: ${{ inputs.sub_ps_min }}
          SUB_Z_MAX: ${{ inputs.sub_z_max }}
          SUB_DD60_MAX: ${{ inputs.sub_dd60_max }}
          # ✅ 레버 상한(진입~연장 전구간)
          MAX_LEVERAGE_PCT: "1.00"

          OUT_DIR: "data/signals"
          EXCLUDE_TICKERS: "SPY,^VIX"
          REQUIRE_FILES: "data/features/features_scored.parquet,app/model.pkl,app/scaler.pkl"

        run: |
          set -euo pipefail
          chmod +x scripts/run_grid_workflow.sh
          bash scripts/run_grid_workflow.sh

      - name: Analyze MAIN vs SUB (pick valid trades parquet)
        shell: bash
        env:
          OUT_DIR: "data/signals"
        run: |
          set -euo pipefail

          echo "[INFO] candidates:"
          ls -lt "${OUT_DIR}"/sim_engine_trades_*_gate_*.parquet | sed -n '1,120p' || true

          latest_trades=""
          for f in $(ls -t ${OUT_DIR}/sim_engine_trades_*_gate_*.parquet 2>/dev/null); do
            ok="$(python - <<PY
          import pandas as pd
          try:
              df = pd.read_parquet("$f")
              cols = set(df.columns)
              # valid if CycleReturn exists OR we can derive it from Invested/Proceeds
              valid = ("CycleReturn" in cols) or (("Invested" in cols) and ("Proceeds" in cols))
              print("1" if valid else "0")
          except Exception as e:
              print("0")
          PY
          )"
            if [ "$ok" = "1" ]; then
              latest_trades="$f"
              break
            fi
          done

          if [ -z "$latest_trades" ]; then
            echo "[ERROR] No valid trades parquet found (needs CycleReturn or Invested+Proceeds)."
            # 디버그: 가장 최신 파일 1개 컬럼 출력
            f0="$(ls -t ${OUT_DIR}/sim_engine_trades_*_gate_*.parquet 2>/dev/null | head -n 1 || true)"
            if [ -n "$f0" ]; then
              echo "[DEBUG] newest file: $f0"
              python - <<PY
          import pandas as pd
          df = pd.read_parquet("$f0")
          print("[DEBUG] cols:", list(df.columns))
          print(df.head(3))
          PY
            fi
            exit 1
          fi

          echo "[INFO] using trades=${latest_trades}"
          prefix="$(basename "$latest_trades" .parquet)"

          python scripts/analyze_sub_vs_main.py \
            --trades-path "$latest_trades" \
            --out-dir "${OUT_DIR}" \
            --prefix "${prefix}" \
            --period "Y"

      - name: Aggregate summaries
        shell: bash
        run: |
          set -euo pipefail
          python scripts/aggregate_gate_grid.py \
            --signals-dir "data/signals" \
            --out-aggregate "data/signals/gate_grid_aggregate.csv" \
            --out-top "data/signals/gate_grid_top_by_recent10y.csv" \
            --pattern "gate_summary_*.csv" \
            --topn 50

      - name: Upload artifacts (signals)
        uses: actions/upload-artifact@v4
        with:
          name: gate-grid-results
          path: |
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/signals/picks_*.csv
            data/signals/picks_meta_*.json
            data/signals/sim_engine_trades_*.parquet
            data/signals/sim_engine_curve_*.parquet
            data/signals/*_sub_main_*.csv
            data/signals/*_sub_worst_*.csv
          if-no-files-found: error